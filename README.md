# Drone Control API

## Описание

Drone Control API — это Python-пакет для дистанционного управления образовательным дроном **DroneCam EDU**. Пакет предоставляет простой и интуитивно понятный интерфейс для взаимодействия с дроном через WebSockets, позволяя выполнять основные действия, такие как взлет, посадка, управление скоростью и направление, а также получать данные от датчиков и камеры дрона.

## Содержание

- [Особенности](#особенности)
- [Установка](#установка)
- [Зависимости](#зависимости)
- [Быстрый старт](#быстрый-старт)
- [Примеры использования](#примеры-использования)
- [API Reference](#api-reference)
- [Вклад](#вклад)
- [Лицензия](#лицензия)

## Особенности

- **Подключение через WebSockets:** Надежное и быстрое соединение с дроном.
- **Управление полетом:** Взлет, посадка, управление скоростью и направлением.
- **Получение данных:** Доступ к данным GPS, барометру, ультразвуковым датчикам и другим сенсорам.
- **Работа с камерой:** Получение изображений с камеры дрона для анализа или отображения.
- **Асинхронность:** Поддержка асинхронных операций для эффективного управления ресурсами.

## Установка

Установка пакета осуществляется через `pip`. Убедитесь, что у вас установлен Python версии 3.6 или выше.

```bash
pip install drone_control_api
```


## Зависимости

Пакет требует наличия следующих зависимостей:

- `websockets`
- `opencv-python`
- `numpy`

Эти зависимости автоматически устанавливаются вместе с пакетом. Однако, вы также можете установить их вручную, используя файл `requirements.txt`:

```bash
pip install -r requirements.txt
```


**Примечание:** Файл `requirements.txt` в данном проекте пуст. Вам необходимо добавить необходимые зависимости или использовать вышеуказанную команду для их установки.

## Быстрый старт

### Подключение к дрону

Ниже приведен пример того, как подключиться к дрону и выполнить основные действия:

```python
from drone_control_api import Drone

client = Drone()
```  

### Запуск примеров

В директории `examples/` находится скрипт `example.py`, демонстрирующий использование пакета. Запустите его следующей командой:

```bash
python examples/example.py
```



## API Reference

### Класс `Drone`

Основной класс для управления дроном.

#### Методы

- **connect(self, ip: str, reset_state: bool = False)**

  Подключается к дрону по указанному IP, если установлен флаг reset_state = True - у дрона сбросится целевая скорость(всегда) и целевая высота(если он не в полете).

- **disconnect()**

  Отключается от дрона.

- **takeoff()**

  Выполняет взлет.

- **landing()**

  Выполняет посадку.

- **set_yaw(yaw: float)**
  
  Устанавливает целевой угол поворота дрона относительно нулевого значения(стартового).

- **set_yaw_relative(yaw: float)**
  
  Поворачавает дрон на угол относительно текущего положения.

- **set_vel_xy(x: float, y: float)**
  
  Устанавливает линейные скорости дрона по осям X и Y.

- **set_vel_xy_yaw(x: float, y: float, yaw: float)**
  
  Устанавливает линейные скорости дрона по осям X и Y и угловую скорость по оси Z.

- **go_to_xy_drone(x: float, y: float)**
  
  Перемещает дрон в заданные координаты по оптической одометрии.

- **go_to_xy_odom(x: float, y: float)**
  
  Перемещает дрон относительно текущей позиции с оптической одометрии.

- **go_to_xy_nav(x: float, y: float)**
  
  Перемещает дрон относительно текущей позиции с помощью методов навигации.

- **set_height(height: float)**
  
  Устанавливает высоту дрона.

- **get_image() -> numpy.ndarray**
  
  Получает изображение с камеры дрона.

- **get_detections()**
  
  Получает данные детекций из нейронной сети.

  Формат возвращаемых данных:

  Если детекций нет: {}

  Если детекции есть:
  {"boxes": [{"name": name, "center": { "x": x, "y": y, "theta": theta }, "area": area, "size_x": size_x, "size_y": size_y }], "image_height": image_height, "image_width": image_width}

- **get_nav_pose()**
  
  Получает позицию из данных навигации.

  Формат возвращаемых данных: [pose_x, pose_y]


#### Особенности реализации методов

Методы управления положением зачастую занимают большое количество времени, что может мешать работе дрона в некоторых сценариях, если выполнять их последовательно.

Поэтому эти методы имеют 2 реализации: синхронную(метод выполняется, блокируя поток исполнения) и асинхронную(метод исполняется не блокируя поток, позволяя вызывать другие методы во время его выполнения)

Список таких методов:

- **takeoff()** - **takeoff_nb(callback)**

- **landing()** - **landing_nb(callback)**

- **go_to_xy_drone(x: float, y: float)** - **go_to_xy_drone_nb(x: float, y: float, callback)**

- **go_to_xy_odom(x: float, y: float)** - **go_to_xy_odom_nb(x: float, y: float, callback)**

- **go_to_xy_nav(x: float, y: float)** - **go_to_xy_nav_nb(x: float, y: float, callback)**

- **set_yaw(yaw: float)** - **set_yaw_nb(yaw: float, callback)**

- **set_yaw_relative(yaw: float)** - **set_yaw_relative_nb(yaw: float, callback)**

Метод с окончанием _nb(non-blocking) не блокирует поток, что позволяет запустить его, и он будет выполняться параллельно основной программе.
Так как метод выполняется параллельно, нам возможно понадобиться получать обратную связь о его выполнении или даже остановить его выполнение.
Для этого предусмотрены методы с окончаниями _feedback и _cancel.

Пример:

- **takeoff()** - обычный блокирующий вызов метода взлета, пока дрон не взлетит на целевую высоту взлета, метод будет блокировать поток - удобно, если требуется сначала взлететь, а потом уже лететь дальше.

- **takeoff_nb(callback)** - неблокирующий метод взлета, при вызове дрон начнет взлетать, продолжив исполнение программы сразу. После завершения выполнения метода вызывается коллбэк(опционально).

- **takeoff_feedback()** - метод получения обратной связи, выведет значение таймера и текущую целевую высоту.

- **takeoff_cancel()** - метод отмены взлета, дрон остановится на той высоте, на которой находился в момент отмены.


Использование коллбэков у неблокирующих методов:


У неблокирующих методов есть возможность вызвать коллбэк после их завершения. Для этого надо объявить функцию с одним аргументом(например msg), чтобы при дальнейшем вызове коллбэка в этот аргумент передались данные о завершении метода.

Функцию обязательно объявлять с одним параметром.

Пример правильной функций для коллбэка:
```
def callback(msg):
    print(msg)
```

Пример приходящего сообщения: {'result': True, 'comment': 'landing done', 'id': '365066c6a7d24223ad019323e36fe6b9'}


## Вклад

Мы приветствуем вклад сообщества в развитие проекта! Если вы нашли ошибку или хотите предложить новую функциональность, пожалуйста, создайте [issue](https://github.com/applied_robotics/drone_control_api/issues) или сделайте [pull request](https://github.com/applied_robotics/drone_control_api/pulls).

## Лицензия

Этот проект лицензирован под лицензией MIT. Подробности см. в файле [LICENSE](https://github.com/applied_robotics/drone_control_api/blob/main/LICENSE).
